<!DOCTYPE html>

<html>
<head>
  <title>node-rhq-metrics</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="node-rhq-metrics">node-rhq-metrics</h1>
<p>Provides a simple asynchronous API in a Node.js environment for fetching 
and writing time-series data in RHQ-metrics.</p>
<h2 id="usage">Usage</h2>
<pre><code><span class="hljs-keyword">var</span> RHQ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-rhq-metrics'</span>);
<span class="hljs-keyword">var</span> rhq = <span class="hljs-keyword">new</span> RHQ({
  host: <span class="hljs-string">'servername.com'</span>,
  port: <span class="hljs-number">9000</span>
});

rhq.get(<span class="hljs-string">'server1'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, result)</span> </span>{
  <span class="hljs-built_in">console</span>.log(result);
});
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><em><strong>RHQ</strong></em> Create a new RHQ object.</p>
<p><strong>options</strong> RHQ server options. Not required.</p>
<ul>
<li><code>options.host</code> - the server hostname. Defaults to <code>&#39;localhost&#39;</code></li>
<li><code>options.port</code> - the server port. Defaults to <code>8080</code></li>
<li><code>options.path</code> - the REST API path. Defaults to <code>&#39;/rhq-metrics/metrics&#39;</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RHQ</span><span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> RHQ)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RHQ(options);
  options = options || {};
  <span class="hljs-keyword">this</span>.host = options.host || <span class="hljs-string">'localhost'</span>;
  <span class="hljs-keyword">this</span>.port = options.port || <span class="hljs-number">8080</span>;
  <span class="hljs-keyword">this</span>.path = options.path || <span class="hljs-string">'/rhq-metrics/metrics'</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><em><strong>RHQ.prototype.get</strong></em> Get a set of time series data for a given <code>id</code>.</p>
<p><strong>id</strong> a string identifier for the dataset. E.g. <code>&#39;server1&#39;</code></p>
<p><strong>options</strong> an object specifying query options (optional)</p>
<ul>
<li><code>options.start</code> - the start date in msec since the epoch. Defaults to
now - 8 hours</li>
<li><code>options.end</code> - the end date for the dataset in msec since the epoch.
Defaults to now.</li>
<li><code>options.buckets</code> - number of intervals (buckets) to divide the time
range. Setting this to 60, for example, will return 60 equally spaced
intervals for the time period between start and end time, having min, avg,
and max calculated for each interval.</li>
</ul>
<p><strong>callback</strong> an optional callback function. It will be called when all data
  has been retrieved and buffered. Parameters for the callback function 
  are a possible error, and response data as an Array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>RHQ.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, options, callback)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> id !== <span class="hljs-string">'string'</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'id must be a string'</span>);

  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">typeof</span> options) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'object'</span>:
      callback = callback || defaultCallback;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'undefined'</span>:
      options = {};
      callback = callback || defaultCallback;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'function'</span>:
      callback = options;
      options = {};
      <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">var</span> path = [<span class="hljs-keyword">this</span>.path, id].join(<span class="hljs-string">'/'</span>) +
             <span class="hljs-string">'?start='</span> + (options.start || defaultStart()) +
             <span class="hljs-string">'&amp;end='</span> + (options.end || defaultEnd());

  <span class="hljs-keyword">if</span> (options.buckets) path += <span class="hljs-string">'&amp;buckets='</span> + options.buckets;

  <span class="hljs-keyword">var</span> httpOpts = {
    hostname: <span class="hljs-keyword">this</span>.host,
    port: <span class="hljs-keyword">this</span>.port,
    path: path,
  };

  <span class="hljs-keyword">var</span> request = http.get(httpOpts, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(res)</span> </span>{
    <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> streamBuffers.WritableStreamBuffer();

    res.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(chunk)</span> </span>{
      buffer.write(chunk);
    });

    res.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ 
        callback(<span class="hljs-literal">null</span>, <span class="hljs-built_in">JSON</span>.parse(buffer.getContentsAsString(<span class="hljs-string">'utf8'</span>))); 
      });
    });
  });

  request.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(e), <span class="hljs-literal">null</span>);
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>If no callback is provided, just log what we get</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaultCallback</span><span class="hljs-params">(e, b)</span> </span>{
  <span class="hljs-keyword">if</span> (e) {
    <span class="hljs-built_in">console</span>.error(e);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">console</span>.log(b);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>A dataset has a default start parameter of 8 hours ago.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaultStart</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Date</span>.now()-(<span class="hljs-number">8</span>*<span class="hljs-number">60</span>*<span class="hljs-number">60</span>*<span class="hljs-number">1000</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>A dataset has a default end parameter of <code>Date.now()</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaultEnd</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Date</span>.now();
}

<span class="hljs-built_in">module</span>.exports = RHQ;

<span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">var</span> streamBuffers = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream-buffers'</span>);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
